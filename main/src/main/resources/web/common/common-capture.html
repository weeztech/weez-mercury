<polymer-element name="common-capture" hidden>
  <script>
    (function () {
      var activeCC = {};

      Polymer.addEventListener(document, 'tap', updateCapture);
      Polymer.addEventListener(document, 'focus', updateCapture, true);

      function updateCapture(e) {
        var obj = {};
        for (var i = 0; i < e.path.length; i++) {
          var el = e.path[i];
          if (el.commonCapture) {
            var cc = el.commonCapture;
            cc.active = true;
            obj[cc.captureId] = cc;
          }
        }
        for (var id in activeCC) {
          if (!(id in obj))
            activeCC[id].active = false;
        }
        activeCC = obj;
      }

      var id = 0;

      Polymer({
        publish: {
          target: null,
          active: false
        },
        created: function () {
          this.captureId = id++;
        },
        domReady: function () {
          if (!this.target)
            this.target = this.parentNode;
        },
        targetChanged: function () {
          if (this._target)
            delete this._target.commonCapture;
          this._target = this.target;
          if (this._target)
            this._target.commonCapture = this;
          this.clear();
        },
        detached: function () {
          if (this._target) {
            delete this._target.commonCapture;
            this._target = null;
          }
          this.clear();
        },
        clear: function () {
          delete activeCC[this.captureId];
        }
      });
    })();
  </script>
</polymer-element>