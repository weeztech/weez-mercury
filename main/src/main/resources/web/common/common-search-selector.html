<link rel="import" href="../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="common-search-input.html">
<link rel="import" href="common-pager.html">
<link rel="import" href="common-selection.html">
<link rel="import" href="common-capture.html">

<polymer-element name="common-search-selector">
  <template>
    <style>
      :host {
        display: block;
      }
      common-search-input {
        width: 100%;
      }
    </style>
    <div id="selectedArea">
      <content select="template[for='selected']"></content>
    </div>
    <common-search-input value="{{keywords}}"></common-search-input>
    <core-collapse class="selectorArea">
      <common-pager id="pager" keywords="{{keywords}}" style="height: {{pagerHeight}}px">
        <content select="template"></content>
      </common-pager>
    </core-collapse>
    <common-capture active="{{active}}"></common-capture>
    <common-selection selected="{{selected}}" selectedBox="{{selectedBox}}" multi?="{{multi}}">
      <common-selector target="{{$.pager}}"></common-selector>
    </common-selection>
  </template>
  <script>
    Polymer({
      publish: {
        selected: null,
        multi: false,
        pagerHeight: 240,
        active: {
          value: false,
          reflect: true
        }
      },
      observe: {
        'selectedBox multi': 'updateSelection'
      },
      domReady: function () {
        var arr = this.shadowRoot.querySelectorAll('content');
        var tpl = arr[0].getDistributedNodes()[0] || arr[1].getDistributedNodes()[0];
        if (!tpl) throw new Error('template not found');
        if (tpl.hasAttribute('repeat') || tpl.hasAttribute('bind') || tpl.hasAttribute('if'))
          throw new Error('cannot use template with repeat/if/bind attribute');
        var clone = this.ownerDocument.importNode(tpl, false);
        if (clone.hasAttribute('norepeat')) {
          clone.setAttribute('bind', '{{selectedBoxArray}}');
        } else {
          clone.setAttribute('repeat', '{{selectedBoxArray}}');
        }
        this.$.selectedArea.appendChild(clone);
        HTMLTemplateElement.decorate(clone, tpl);
        clone.bindingDelegate = this.element.syntax;
        clone.model = this;
        this.selectionTemplate = clone;
      },
      detached: function () {
        if (this.selectionTemplate) {
          this.selectionTemplate.unbind('repeat');
          this.selectionTemplate = null;
        }
      },
      updateSelection: function () {
        if (this.selectedBox) {
          this.selectedBoxArray = this.multi ? this.selectedBox : [this.selectedBox];
        } else {
          this.selectedBoxArray = null;
        }
      }
    });
  </script>
</polymer-element>