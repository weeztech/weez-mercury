<polymer-element name="common-selection" hidden>
  <script>
    Polymer({
      publish: {
        selected: null,
        selectedBox: null,
        multi: false
      },
      multiChanged: function () {
        this.clear();
        this._multi = this.multi;
      },
      getSelectedBox: function (key) {
        var selbox = this.selectedBox;
        if (selbox) {
          return selbox[key];
        }
      },
      packup: function (items, keyGetter) {
        var boxes = [];
        if (this._multi) {
          var selbox = this.selectedBox || (this.selectedBox = {});
          for (var i = 0; i < items.length; i++) {
            var item = items[i];
            var key = keyGetter(item);
            var box = selbox[key];
            if (box) {
              box.value = item;
            } else {
              box = {
                key: key,
                value: item,
                selected: false
              };
            }
            boxes.push(box);
          }
        } else {
          var selkey = this.selectedBox && this.selectedBox.key;
          for (var i = 0; i < items.length; i++) {
            var item = items[i];
            var key = keyGetter(item);
            var box = this.selectedBox;
            if (box && box.key == key) {
              box.value = item;
            } else {
              box = {
                key: key,
                value: item,
                selected: false
              };
            }
            boxes.push(box);
          }
        }
        return boxes;
      },
      clear: function () {
        if (this.selectedBox) {
          if (this._multi) {
            for (var key in this.selectedBox)
              this.selectedBox[key].selected = false;
          } else {
            this.selectedBox.selected = false;
          }
        }
        this.selectedBox = null;
        this.selected = null;
      },
      select: function () {
        this._select(arguments, 1);
      },
      deselect: function () {
        this._select(arguments, 0);
      },
      toggle: function () {
        this._select(arguments, 2);
      },
      _select: function (args, act) {
        if (this._multi) {
          var selbox = this.selectedBox || (this.selectedBox = {});
          var sel = this.selected || (this.selected = []);
          for (var i = 0; i < args.length; i++) {
            var box = args[i];
            var toggle = !!(act ^ box.selected);
            if (!toggle) continue;
            if (box.selected) {
              box.selected = false;
              delete selbox[box.key];
              sel.splice(sel.indexOf(box.value), 1);
            } else {
              box.selected = true;
              selbox[box.key] = box;
              sel.push(box.value);
            }
          }
        } else {
          var box = args[0];
          var toggle = !!(act ^ box.selected);
          if (toggle) {
            if (this.selectedBox) {
              this.selectedBox.selected = false;
              this.selectedBox = null;
              this.selected = null;
            }
            if (!box.selected) {
              box.selected = true;
              this.selectedBox = box;
              this.selected = box.value;
            }
          }
        }
      }
    });
  </script>
</polymer-element>

<polymer-element name="common-selector">
  <script>
    (function () {
      var events = makeEvents('common-query common-select common-deselect');

      function makeEvents(s) {
        var events = [];
        var names = s.split(' ');
        for (var i = 0; i < names.length; i++) {
          var name = names[i];
          var handler = name.replace(/-./, function (m) {
            return m[1].toUpperCase();
          }) + 'Action';
          events.push({
            name: name,
            handler: handler
          });
        }
        return events;
      }

      Polymer({
        publish: {
          target: null,
          model: ''
        },
        created: function () {
          for (var i = 0; i < events.length; i++) {
            var name = events[i].handler;
            this['_' + name] = this[name].bind(this);
          }
        },
        domReady: function () {
          var parent = this.parentNode;
          if (!parent || parent.localName != 'common-selection')
            throw new Error('do not use common-selector out of common-selection');
        },
        detached: function () {
          if (this._target) {
            this.updateListener(false);
            this._target = null;
          }
        },
        updateListener: function (addOrRemove) {
          var func = Polymer[addOrRemove ? 'addEventListener' : 'removeEventListener'];
          for (var i = 0; i < events.length; i++) {
            var event = events[i];
            func(this._target, event.name, this['_' + event.handler]);
          }
        },
        targetChanged: function () {
          if (this._target) this.updateListener(false);
          this._target = this.target;
          if (this._target) this.updateListener(true);
        },
        commonQueryAction: function (e) {
          var detail = e.detail;
          if (detail.filter)
            throw new Error('cannot hook multiple filters on one element');
          var self = this;
          detail.filter = function (p) {
            return p.then(function (result) {
              var keyprop = result.keyprop,
                keyGetter;
              switch (typeof keyprop) {
              case 'string':
                keyGetter = function (item) {
                  return item[keyprop];
                };
                break;
              case 'function':
                keyGetter = keyprop;
                break;
              default:
                throw new Error('invalid keyprop');
              }
              result.items = self.parentNode.packup(result.items, keyGetter);
              return result;
            });
          };
        },
        boxOf: function (el) {
          var box = el.templateInstance.model;
          if (this.model) box = box[this.model];
          return box;
        },
        commonSelectAction: function (e) {
          var el = e.path[0];
          while (!el.templateInstance_)
            el = el.parentNode;
          if (this.parentNode.multi) {
            var modifiers = e.detail.modifiers;
            if (modifiers == 0) {
              var box = this.boxOf(el);
              this.parentNode.toggle(box);
              this.lastState = box.selected;
            } else if (modifiers == 8) { // shift
              var boxes = [],
                fromEl = this.lastTap || el.parentNode.firstElementChild,
                toEl = el;
              // not support cross level selection
              if (fromEl.parentNode !== toEl.parentNode) return;
              if (fromEl.compareDocumentPosition(toEl) & Node.DOCUMENT_POSITION_PRECEDING) {
                toEl = fromEl;
                fromEl = el;
              }
              toEl = toEl.nextElementSibling;
              var boxes = [],
                lastBox;
              for (var itemEl = fromEl; itemEl != toEl; itemEl = itemEl.nextElementSibling) {
                var box = this.boxOf(itemEl);
                if (box !== lastBox) {
                  boxes.push(box);
                  lastBox = box;
                }
              }
              var func = this.lastState ? this.parentNode.select : this.parentNode.deselect;
              func.apply(this.parentNode, boxes);
            }
            this.lastTap = el;
          } else {
            var box = this.boxOf(el);
            this.parentNode.select(box);
          }
        },
        commonDeselectAction: function (e) {
          var el = e.path[0];
          while (!el.templateInstance_)
            el = el.parentNode;
          var box = this.boxOf(el);
          this.parentNode.deselect(box);
        }
      });
    })();
  </script>
</polymer-element>