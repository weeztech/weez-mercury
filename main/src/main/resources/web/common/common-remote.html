<script>
  var Weez = {};

  (function (scope) {
    var sid = null;

    function init() {
      return ajax({
        method: 'POST',
        url: '/init',
        type: 'json',
        request: null
      }).then(function (resp) {
        if (resp.error) {
          throw processError(resp);
        }
        sid = resp.result;
        if (!sid)
          throw new Error('invalid session id');
      });
    }

    function ajax(opts) {
      var xhr = new XMLHttpRequest();
      var cancel = false;
      var done = false;
      var p = new Promise(function (resolve, reject) {
        xhr.open(opts.method, opts.url);
        xhr.send(opts.request);
        xhr.onreadystatechange = function () {
          if (cancel) return;
          if (xhr.readyState == 4) {
            done = true;
            if (xhr.status == 200) {
              resolve(xhr.response);
            } else {
              reject(new Error(xhr.status + ' - ' + xhr.statusText));
            }
          }
        };
        xhr.ontimeout = function () {
          reject(new Error('timeout'));
        };
        xhr.responseType = opts.type;
      });
      p.cancel = function () {
        if (!cancel && !done) {
          cancel = true;
          xhr.abort();
        }
      };
      p.fail = p['catch'];
      p.fail(function (err) {
        console.log(err.stack || err);
      });
      return p;
    }

    function remoteCall(opts, obj) {
      if (!sid) throw new Error('call init() first');
      var api = opts.api || opts;
      var type = opts.type || 'json';
      var request = JSON.stringify({
        sid: sid,
        request: obj
      });
      return ajax({
        method: 'POST',
        url: '/service/com.weez.mercury.' + api,
        type: type,
        request: request
      }).then(function (resp) {
        if (type == 'json') {
          if (resp.error) {
            reject(processError(resp));
          } else {
            resolve(resp.response);
          }
        } else {
          resolve(resp);
        }
      });
    }

    function processError(json) {
      var code = json.error;
      switch (code) {
      case 800: // InvalidRequest: the request contains characters cannot be parsed or has invalid format
        return new Error('800 - 请求无法被服务器处理');
      case 801: // NotAcceptable: the request is not acceptable becuase cannot find RemoteCall
        return new Error('801 - 请求无法被服务器处理');
      case 802: // Reject: the request is not acceptable because too many requests are waiting
        return new Error('802 - 服务器忙,请稍后重试');
      }
    }

    scope.remoteCall = remoteCall;
    scope.init = init;
  })(Weez);
</script>