<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/core-scroll-threshold/core-scroll-threshold.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="common-resizable.html">

<polymer-element name="common-pager" vertical layout>
  <template>
    <style>
      :host {
        display: block;
      }
      #scrollThreshold {
        display: block;
        overflow: auto;
      }
      .error {
        margin-top: 8px;
        color: #777;
      }
    </style>
    <core-scroll-threshold id="scrollThreshold" lowerThreshold="{{threshold}}" on-lower-trigger="{{loadMore}}" flex>
      <div>
        <content></content>
      </div>
      <div vertical layout center hidden?="{{!loading}}">
        <paper-spinner active></paper-spinner>
      </div>
      <div hidden?="{{!error}}" vertical layout center>
        <span class="error">从服务器获取数据时发生错误：{{error}}</span>
        <paper-icon-button icon="refresh" on-tap="{{retryAction}}"></paper-icon-button>
      </div>
      <common-resizable on-common-resize="{{fill}}"></common-resizable>
    </core-scroll-threshold>
  </template>
  <script>
    Polymer({
      publish: {
        threshold: 20
      },
      loading: false,
      hasMore: true,
      domReady: function () {
        this.isReady = true;
        this.fill();
      },
      retryAction: function () {
        this.error = null;
        this.loadMore();
      },
      reload: function () {
        if (!this.isReady) return;
        this.hasMore = true;
        this.items = null;
        this.error = null;
        this.loadMore();
      },
      fill: function () {
        this.async(function () {
          if (this.loading) return;
          var el = this.$.scrollThreshold;
          if (el.scrollHeight <= el.clientHeight && el.clientHeight > 0) {
            this.loadMore();
          }
        });
      },
      loadMore: function () {
        if (!this.hasMore || this.error) return;
        this.loading = true;
        var detail = {};
        this.fire('common-query', detail);
        var result = detail.result;
        if (typeof result == 'undefined')
          throw new Error('no response on common-query');
        if (result.then) {
          result.then(this.afterQuery.bind(this));
        } else {
          this.afterQuery(result);
        }
      },
      afterQuery: function (result) {
        this.loading = false;
        if (result instanceof Error) {
          this.error = result.message;
          return;
        }
        this.hasMore = result;
        this.$.scrollThreshold.clearLower();
        this.fill();
      }
    });
  </script>
</polymer-element>