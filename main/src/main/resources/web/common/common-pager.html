<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/core-scroll-threshold/core-scroll-threshold.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="common-resizable.html">

<polymer-element name="common-pager" vertical layout>
  <template>
    <style>
      :host {
        display: block;
      }
      #scrollThreshold {
        display: block;
        overflow: auto;
      }
      .error {
        margin-top: 8px;
        color: #777;
      }
    </style>
    <content id="content" select="template"></content>
    <core-scroll-threshold id="scrollThreshold" lowerThreshold="{{threshold}}" on-lower-trigger="{{loadMore}}" flex>
      <div id="list"></div>
      <div vertical layout center hidden?="{{!loading}}">
        <paper-spinner active></paper-spinner>
      </div>
      <div hidden?="{{!error}}" vertical layout center>
        <span class="error">从服务器获取数据时发生错误：{{error}}</span>
        <paper-icon-button icon="refresh" on-tap="{{retryAction}}"></paper-icon-button>
      </div>
      <common-resizable on-common-resize="{{fill}}"></common-resizable>
    </core-scroll-threshold>
  </template>
  <script>
    Polymer({
      publish: {
        threshold: 20,
        keywords: ''
      },
      loading: false,
      hasMore: true,
      domReady: function () {
        var arr = this.$.content.getDistributedNodes();
        if (arr.length > 1) throw new Error('multiple templates found');
        if (arr.length == 0) throw new Error('cannot find template');
        var tpl = arr[0];
        if (tpl.hasAttribute('repeat') || tpl.hasAttribute('bind') || tpl.hasAttribute('if'))
          throw new Error('cannot use template with repeat/if/bind attribute');
        var clone = this.ownerDocument.importNode(tpl, false);
        if (clone.hasAttribute('norepeat')) {
          clone.setAttribute('bind', '{{items}}');
        } else {
          clone.setAttribute('repeat', '{{items}}');
        }
        this.$.list.appendChild(clone);
        HTMLTemplateElement.decorate(clone, tpl);
        clone.bindingDelegate = this.element.syntax;
        clone.model = this;
        this.itemTemplate = clone;
        this.isReady = true;
        this.fill();
      },
      detached: function () {
        if (this.itemTemplate) {
          this.itemTemplate.unbind('repeat');
          this.itemTemplate = null;
        }
      },
      keywordsChanged: function () {
        this.reload();
      },
      retryAction: function () {
        this.error = null;
        this.loadMore();
      },
      reload: function () {
        if (!this.isReady) return;
        this.hasMore = true;
        this.items = null;
        this.loadMore();
      },
      fill: function () {
        this.async(function () {
          if (this.loading) return;
          var el = this.$.scrollThreshold;
          if (el.scrollHeight <= el.clientHeight && el.clientHeight > 0) {
            this.loadMore();
          }
        });
      },
      loadMore: function () {
        if (!this.hasMore || this.error) return;
        var msgId = this.msgId ? ++this.msgId : (this.msgId = 1);
        var detail = {};
        this.beforeQuery(detail);
        this.fire('common-query', detail);
        var result = detail.result;
        if (!result)
          throw new Error('no response on common-query');
        if (!result.then) {
          result = Promise.resolve(result);
        }
        if (detail.filter) result = detail.filter(result);
        result.then(this.afterQuery.bind(this));
      },
      beforeQuery: function (detail) {
        detail.start = this.items ? this.items.length : 0;
        detail.keywords = this.keywords;
        this.loading = true;
        this.error = null;
      },
      afterQuery: function (result) {
        if (result instanceof Error) {
          this.error = result.message;
          this.loading = false;
          return;
        }
        this.hasMore = result.hasMore;
        if (this.items)
          Array.prototype.push.apply(this.items, result.items);
        else
          this.items = result.items;
        this.loading = false;
        this.$.scrollThreshold.clearLower();
        this.fill();
      }
    });
  </script>
</polymer-element>