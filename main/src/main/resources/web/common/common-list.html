<polymer-element name="common-selector" extends="common-pager">
  <script>
    Polymer({
      publish: {
        selection: null
      },
      domReady: function () {
        this.super();
        Polymer.addEventListener(this.$.list, 'tap', this.tapAction.bind(this));
      },
      selectionChanged: function () {
        if (this._selection) {
          this._selection.clear();
        }
        this._selection = this.selection;
        this.reload();
      },
      tapAction: function (e) {
        if (!this._selection || !this.$.list.contains(e.target)) return;
        var el = e.target;
        while (el && el.parentNode != this.$.list)
          el = el.parentNode;
        if (el && el.localName != 'template') {
          if (this._selection.multi) {
            this.multiSelectAction(e, el);
          } else {
            this.singleSelectAction(e, el);
          }
        }
      },
      singleSelectAction: function (e, el) {
        var box = this.boxOf(el);
        this._selection.select(box);
        this.lastTap = el;
      },
      multiSelectAction: function (e, el) {
        var modifier = 0;
        if (e.metaKey) modifier |= 1;
        if (e.ctrlKey) modifier |= 2;
        if (e.altKey) modifier |= 4;
        if (e.shiftKey) modifier |= 8;
        if (modifier == 0) {
          var box = this.boxOf(el);
          if (box.selected)
            this._selection.deselect(box);
          else
            this._selection.select(box);
        } else if (modifier == 8) {
          var lastEl = this.lastTap || this.$.list.children[1]; // skip template
          if (lastEl.compareDocumentPosition(el) & Node.DOCUMENT_POSITION_FOLLOWING) {

          }
        }
        this.lastTap = el;
      },
      boxOf: function (el) {
        return el.templateInstance.model;
      },
      afterQuery: function (result) {
        if (!this._selection) return;
        result.items = this._selection.packup(result.items);
        this.super([result]);
      },
      reload: function () {
        if (!this._selection) return;
        this.super();
      }
    });
  </script>
</polymer-element>


